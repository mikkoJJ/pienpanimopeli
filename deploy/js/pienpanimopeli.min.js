var Brew={game:null,noCursor:false};(function(){Brew.Booter=function(){return};Brew.Booter.prototype={preload:function(){WebFont.load({google:{families:["VT323","Press Start 2P"]}});console.log("BOOT: Web fonts loaded.");return},update:function(){this.state.add("Preloader",Brew.Preloader,true)}}})();(function(){var game=new Phaser.Game(960,720,Phaser.AUTO,"game");game.state.add("Booter",Brew.Booter,true);Brew.game=game})();(function(){Brew.Preloader=function(){return};Brew.Preloader.prototype={create:function(){this.state.add("Main",Brew.Main)},preload:function(){this.progress=this.game.add.text(this.game.width/2,this.game.height/2,"Loading: 0 %",{font:'40pt bold "Press Start 2P"',fill:"#FFFFFF"});this.progress.anchor.set(.5);this.progress.fixedToCamera=true;Brew.game.plugins.add(new Phaser.Plugin.Isometric(Brew.game));this.load.image("kattila","assets/sprites/single_sprites/kattila.png");this.load.image("paa_kattila_luonnos","assets/sprites/single_sprites/paa_kattila_luonnos.png");this.load.atlasJSONHash("sprites","assets/sprites/brew_sprites.png","assets/sprites/brew_sprites_data.json");this.load.json("texts","assets/json/texts.json");console.log("PRELOAD: Images loaded");Brew.gui=new Brew.GUI;console.log("PRELOAD: GUI initialized")},loadUpdate:function(){this.progress.text="Loading: "+this.load.progress+" %"},update:function(){this.state.start("Main")}}})();(function(){var settings={tileSize:38};var letter,i=0,budget=5e4,lauterer,fermenter,lagerStorage,porterStorage,darkStorage,person,person2,spending;Brew.Main=function(){return};Brew.Main.prototype={create:function(){this.game.iso.anchor.setTo(.5,.2);this.messages=new Brew.Messages;this.isoGroup=this.add.group();this.floor=new Brew.Floor;this.floor.makeFloor(this.game,this.isoGroup);lagerStorage=new Brew.Storage(this.game,"lager_case",this.isoGroup);lagerStorage.base.x=0*settings.tileSize;lagerStorage.base.y=0*settings.tileSize;lagerStorage.amount=10;porterStorage=new Brew.Storage(this.game,"porter_case",this.isoGroup);porterStorage.base.x=0*settings.tileSize;porterStorage.base.y=3*settings.tileSize;porterStorage.amount=10;darkStorage=new Brew.Storage(this.game,"dark_case",this.isoGroup);darkStorage.base.x=0*settings.tileSize;darkStorage.base.y=6*settings.tileSize;darkStorage.amount=10;lauterer=new Brew.Producer(this.game,4*settings.tileSize,3*settings.tileSize,0,"kettle",this.isoGroup);fermenter=new Brew.Producer(this.game,6*settings.tileSize,3*settings.tileSize,0,"fermenter",this.isoGroup);Brew.Producer.setChain(lauterer,fermenter);this.cursor=this.add.isoSprite(0,0,1,"sprites","select",this.isoGroup);this.cursor.anchor.setTo(.5,.5);this.isoGroup.add(this.cursor);person=new Person(this.game,1*settings.tileSize,4*settings.tileSize,10,this.isoGroup,this.floor);person2=new Person(this.game,1*settings.tileSize,5*settings.tileSize,10,this.isoGroup,this.floor);person.anchor.setTo(.5,1);person2.anchor.setTo(.5,1);var seek=this.add.button(900,0,"sprites",function(){Brew.gui.addMessage("Työhakemus","Moi, olen Ville Viinamäki",null,"palkkaa",this.hire)},this,"seek-employee-symbol","seek-employee-symbol");seek.anchor.setTo(.5,0);seek.scale.set(.8,.8);var coin=this.add.button(910,100,"sprites",function(){Brew.gui.addMessage("Mainosta","Rakenna jättitölkki?",null,"Oi kyllä!",this.ad)},this,"coin-symbol","coin-symbol");coin.anchor.setTo(.5,0);var mallas=this.add.button(900,200,"sprites",function(){alert("ostit raaka-aineita")},this,"mallas_symbol","mallas_symbol");mallas.anchor.setTo(.5,0);mallas.scale.set(.5,.5);letter=this.add.button(50,5,"sprites",function(){Brew.gui.toggleMessages()},this,"letter_open","letter","letter_open","letter_open");letter.anchor.setTo(.5,0);this.time.events.loop(Phaser.Timer.SECOND*20,this.updateCounter,this);Brew.Budget.create();Brew.Budget.moveProgressBar();Brew.Budget.update(5e4);$("#rahaa").text(budget);spending=$("#kulutus").val();$("#kulutus").on("blur",function(){spending=$(this).val()});this.time.events.loop(Phaser.Timer.SECOND*10,function(){budget=budget-parseInt(spending);Brew.Budget.update(budget);$("#rahaa").text(budget)},this)},ad:function(){budget=budget-100;Brew.Budget.update(budget);$("#rahaa").text(budget);Brew.gui.alert("Jättitölkkisi on laiton, sait sakot. Think of the children!")},hire:function(){spending=parseInt(spending)+500;var employee=new Person(Brew.game,Brew.game.rnd.integerInRange(0,9)*settings.tileSize,9*settings.tileSize,10,this.isoGroup);employee.anchor.setTo(.5,1)},sell:function(order){if(storage.amount<order.amount)return false;else if(order.buyer=="Nalle"){budget=budget-10;$("#rahaa").text(budget);var message=Brew.Budget.update(budget);Brew.gui.alert("Yksityishenkilölle myyminen on laitonta! Sait sakot."+message)}else{budget=budget+order.price*order.amount;$("#rahaa").text(budget);var message=Brew.Budget.update(budget);storage.amount-=order.amount;if(budget>=1e5){Brew.gui.alert("Liikevoittosi on ilmiömäinen. "+message)}}},updateCounter:function(){var order=(new Order).random();var list=[];list[i++]=Brew.gui.addMessage("Tilaus",order.message(),order,"Myy",this.sell);var now=this.time.totalElapsedSeconds();if(now-order.age>10){}},update:function(){this.game.iso.simpleSort(this.isoGroup);this.messages.update();var _pos=new Phaser.Plugin.Isometric.Point3;this.game.iso.unproject(this.game.input.activePointer.position,_pos);if(Brew.noCursor){this.cursor.isoX=this.cursor.isoY=-1e3;return}this.isoGroup.forEach(function(tile){var inBounds=tile.isoBounds.containsXY(_pos.x,_pos.y);if(inBounds){this.cursor.isoX=tile.isoX;this.cursor.isoY=tile.isoY}},this);this.floor.update()}};var Person=function(game,x,y,z,group,floor){Phaser.Plugin.Isometric.IsoSprite.call(this,game,x,y,z,"sprites","mies",group);this.anchor.set(.5,.7);this.floor=floor;this.moving=false;this.inputEnabled=true;this.events.onInputDown.add(function(){this.floor.person=this},this);game.add.existing(this);group.add(this)};Person.prototype=Object.create(Phaser.Plugin.Isometric.IsoSprite.prototype);Person.prototype.constructor=Person;Brew.Person=Person;var Order=function(type,amount,buyer){this.type=type;this.amount=amount;this.buyer=buyer;this.price=$("#hinta").val();$("#hinta").on("blur",function(){hinta=$(this).val()})};Order.prototype.random=function(){var types=["lageria","tummaa olutta","portteria"];var buyers=["Kesko","Hemingways","Vakiopaine","Musta Kynnys","Ale Pub","S-Ryhmä","Nalle"];var pieni=Brew.game.rnd.integerInRange(0,10);var suuri=Brew.game.rnd.integerInRange(30,40);var amountTypes=[pieni,suuri];return new Order(types[Brew.game.rnd.integerInRange(0,types.length-1)],Brew.game.rnd.integerInRange(1,10),buyers[Brew.game.rnd.integerInRange(0,buyers.length-1)])};Order.prototype.message=function(){return this.amount+" koria "+this.type+" Tilaaja:"+this.buyer};Brew.Order=Order})();(function(){var Messages=function(){};var sakot;Messages.prototype={update:function(){},getMessage:function(){var data=Brew.game.cache.getJSON("texts");sakot=data.letters[0].content;return sakot}};Brew.Messages=Messages})();(function(){var settings={dom:"#game",messagesAnimationSpeed:100,messagesHoverSpeed:100};var GUI=function(){this._messageWindow=$("<div><div/>").addClass("brew-messages").appendTo(settings.dom)};GUI.prototype.alert=function(message,callback,callbackCtx){$("<div><div/>").addClass("brew-window brew-alert").html(message).append(this.__makeButton("OK",function(){var p=$(this).parent();if(p.data("callback"))p.data("callback").call(p.data("callbackCtx"));p.hide("drop",200,"easeInBack",function(){this.remove()})})).appendTo(settings.dom).show("drop",200,"easeOutBack").data("callback",callback).data("callbackCtx",callbackCtx)};GUI.prototype.addMessage=function(header,message,data,buttonText,buttonCallback,buttonCallbackCtx){var _w=$("<div><div/>").addClass("brew-window brew-message").html("<h2>"+header+"<h2>").append($("<div><div/>").addClass("brew-message-body brew-window").html(message)).click(this.__messageWindowClicked).hover(this.__messageWindowHover,this.__messageWindowHover).data("messageData",data).appendTo(this._messageWindow);if(buttonText){_w.append(this.__makeButton(buttonText,function(e){var $this=$(this);var remove=true;if($this.data("callback"))remove=$this.data("callback").call($this.data("callbackCtx"),$this.parent().data("messageData"));if(remove!==false)$this.parent().hide("fold",200,"easeInBack",function(){$(this).remove()});else e.stopPropagation()}).css({display:"none"}).data("callback",buttonCallback).data("callbackCtx",buttonCallbackCtx))}};GUI.prototype.toggleMessages=function(){this.__closeOpenMessages();this._messageWindow.toggle("slide",{easing:"easeOutBounce"},200)};GUI.prototype.__makeButton=function(text,callback){return $("<div></div>").addClass("brew-button").addClass("jotain").text(text).click(callback)};GUI.prototype.__messageWindowHover=function(){$(this).toggleClass("brew-message-extended",settings.messagesHoverSpeed)};GUI.prototype.__closeOpenMessages=function(){$(".brew-message-open").each(function(){$(this).toggleClass("brew-message-open",settings.messagesAnimationSpeed,"easeOutBounce");$(this).children(".brew-message-body, .brew-button").toggle("fold",{direction:"up",easing:"easeOutQuad"},settings.messagesAnimationSpeed)})};GUI.prototype.__messageWindowClicked=function(){var $this=$(this);if(!$this.hasClass("brew-message-open")){$(".brew-message-open").each(function(){$(this).toggleClass("brew-message-open",settings.messagesAnimationSpeed,"easeOutBounce");$(this).children(".brew-message-body, .brew-button").toggle("fold",{direction:"up",easing:"easeOutQuad"},settings.messagesAnimationSpeed)})}$this.toggleClass("brew-message-open",settings.messagesAnimationSpeed,"easeOutBounce");$this.children(".brew-message-body, .brew-button").toggle("fold",{direction:"up",easing:"easeOutQuad"},settings.messagesAnimationSpeed)};Brew.GUI=GUI})();(function(){var settings={dom:"#progressbar",progressStyle:{width:"100%",height:"25px"},wrapStyle:{background:"#f80",margin:"10px",overflow:"hidden",position:"relative"},barStyle:{background:"#ddd",left:"0",position:"absolute",top:"0"}};var div;var bar;var full=1e5;var Budget=function(){};Budget.prototype.update=function(money){var percent=money/1e3;var message;if(percent<=0){percent=0;Brew.gui.alert("Menetit kaikki rahasi ja hävisit pelin.")}else if(percent>=100){percent=100;Brew.gui.alert("Voitit pelin!")}else message="";div.data("percent",percent);this.moveProgressBar();return message};Budget.prototype.moveProgressBar=function(){var getPercent=div.data("percent")/100;var getProgressWrapWidth=div.width();var progressTotal=getPercent*getProgressWrapWidth;var animationLength=250;bar.stop().animate({left:progressTotal},animationLength)};Budget.prototype.create=function(){bar=$("<div>").css(settings.progressStyle).css(settings.barStyle);div=$("<div>").css(settings.progressStyle).css(settings.wrapStyle).data("percent",100).append(bar).appendTo(settings.dom)};Brew.Budget=new Budget})();(function(){Brew.BeerType={LAGER:1,PORTER:2,DARK:3};var Beer=function(){};Brew.Beer=Beer})();(function(){var settings={tileWidth:38,caseHeight:18,pileHeight:5,pileWidth:4,caseValue:1};var Storage=function(game,spriteName,group){this._game=game;this._group=group;this._frame=spriteName;this._amount=0;this._cases=[];this._current={x:0,y:0,z:0}};Storage.prototype.base={x:0,y:0,z:0};Storage.prototype.addCase=function(){var _case=this._game.add.isoSprite(0,0,0,"sprites",this._frame,this._group);_case.anchor.set(.5,.76);_case.isoX=this.base.x+settings.tileWidth*this._current.x;_case.isoY=this.base.y+settings.tileWidth*this._current.y;_case.isoZ=this.base.z+settings.caseHeight*this._current.z;_case.inputEnabled=true;_case.casePosition={x:this._current.x,y:this._current.y,z:this._current.z};if(++this._current.z>=settings.pileHeight){if(++this._current.x>=settings.pileWidth){this._current.y++;this._current.x=0}this._current.z=0}this._cases.push(_case)};Storage.prototype.moveEmployee=function(){Brew.game.add.tween(Brew.Person).to({isoX:this._current.x+130,isoY:this._current.y,isoZ:0},2e3,Phaser.Easing.Linear.None,true,0,0,false)};Storage.prototype.removeCase=function(){var _case=this._cases.pop();this._current.x=_case.casePosition.x;this._current.y=_case.casePosition.y;this._current.z=_case.casePosition.z;_case.destroy()};Object.defineProperty(Storage.prototype,"amount",{get:function(){return this._amount},set:function(newAmount){var caseDifference=Math.floor(newAmount/settings.caseValue)-this._cases.length;if(caseDifference<0)for(var i=caseDifference;i<0;i++)this.removeCase();else for(var j=0;j<caseDifference;j++)this.addCase();this._amount=newAmount}});Brew.Storage=Storage})();(function(){var settings={tileSize:38};var graph=[[0,0,0,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,0,0,0,0,1,1,1],[1,1,1,0,0,0,0,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1]];var easystar=new EasyStar.js;var intervals={};easystar.setIterationsPerCalculation(10);var Floor=function(){this.grid=easystar.setGrid(graph);easystar.setAcceptableTiles([1]);this.person=Brew.person;this.destination=null};Floor.prototype.makeFloor=function(game,isoGroup){var tile;for(var xx=0;xx<10*settings.tileSize;xx+=settings.tileSize){for(var yy=0;yy<10*settings.tileSize;yy+=settings.tileSize){tile=game.add.isoSprite(xx,yy,0,"sprites","floor",isoGroup);tile.inputEnabled=true;tile.events.onInputDown.add(this.move,this,{param1:tile});tile.anchor.set(.5,.5)}}};Floor.prototype.setElement=function(element){graph[Math.floor(element.isoX/settings.tileSize)][Math.floor(element.isoY/settings.tileSize)]=0;this.grid=easystar.setGrid(graph)};Floor.prototype.move=function(destination){var person=this.person;this.destination=destination;if(person==undefined||person.moving==true){return}var start=[Math.floor(person.isoX/settings.tileSize),Math.floor(person.isoY/settings.tileSize)];var end=[Math.floor(this.destination.isoX/settings.tileSize),Math.floor(this.destination.isoY/settings.tileSize)];easystar.findPath(start[0],start[1],end[0],end[1],function(path){if(path===null){alert("Path was not found.")}else{person.moving=true;var id=setInterval(function(){person.isoX=path[0].x*settings.tileSize;person.isoY=path[0].y*settings.tileSize;path.splice(0,1);if(path.length==0){person.moving=false;finished=true;delete intervals[id];clearInterval(id)}},500);intervals[id]=true}});this.grid=easystar.setGrid(graph)};Floor.prototype.update=function(){easystar.calculate()};Brew.Floor=Floor})();(function(){Brew.ProducerState={IDLE:1,PROCESSING:2,DONE:3};var Producer=function(game,x,y,z,frame,group){this._sprite=game.add.isoSprite(x,y,z,"sprites",frame,group);this._game=game;this.state=Brew.ProducerState.IDLE;this.next=null;this.previous=null;this.beer=null;this.resource=null;this.isFinal=false;this.workDuration=10;this._sprite.anchor.setTo(.5,.97);this._sprite.inputEnabled=true;this._sprite.events.onInputDown.add(this._inputDown,this)};Producer.prototype=Object.create(Phaser.Plugin.Isometric.IsoSprite.prototype);Producer.prototype.constructor=Producer;Producer.prototype.begin=function(from){var beer;if(from){beer=from.beer;from.end()}else this.beer=beer;var workTween=this._game.add.tween(this._sprite.scale).to({x:1.05,y:1.05},100,Phaser.Easing.Linear.None,true,0,this.workDuration,true);workTween.onComplete.add(function(){this.state=Brew.ProducerState.DONE},this);this.state=Brew.ProducerState.PROCESSING};Producer.prototype.end=function(){this.state=Brew.ProducerState.IDLE;this.beer=null};Producer.prototype._inputDown=function(){if(this.state==Brew.ProducerState.IDLE){if(!this.previous){this.begin()}else if(this.previous.state==Brew.ProducerState.DONE){this.begin(this.previous)}}};Producer.setChain=function(){for(var i=0;i<arguments.length;i++){arguments[i].previous=arguments[i-1];arguments[i].next=arguments[i+1]}};Brew.Producer=Producer})();